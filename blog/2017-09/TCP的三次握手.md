# TCP的三次握手步骤详解

许多常见的网络攻击(包括极为流行的SYN洪泛攻击)利用TCP连接管理中的弱点。现在我们观察一下一条TCP连接是如何建立的。假设运行在一台主机(客户)上的一个进程想与另一台主机(服务器)上的一个进程建立一条连接。客服端的TCP会用一下的方式与服务器中的TCP建立一条TCP连接。

## 第一步

客服端的TCP首先向服务器端的TCP发送一个特殊的TCP报文。该报文中不包含应用层数据。但报文的首部中的一个标志位(即**SYN**比特)被置为**1**,因此，这个报文段被称为**SYN报文段**。另外，客户会随机的选择一个**初始序号(client_isn)**,并将次报文段段放置于该起始的TCP SYN报文段的的序号字段中。该报文会被封装在一个IP数据报中，并发送给服务器。

## 第二步

一旦包含TCP SYN 报文段的IP数据报到达服务器主机(假定它的确到达了)服务器会从该数据报中提取出 TCP SYN 报文字段，为该 TCP连接分配 TCP 缓存和变量。并向该客户 TCP 发送允许连接的报文段(由于在三次握手的第三步之前分配了这些缓存和变量，使得TCP易于受到称为SYN洪泛攻击)。这种连接报文也不包含应用层数据。但是该报文段的首部包含三个重要信息。首先**SYN比特被置为1**.其次，该TCP报文段首部的确认号被置为**client\_isn+1**.最后服务器选择自己的**初始序号(server_isn)**.并将其放置到 TCP 报文段的序号字段中。这个允许连接的报文实际上表明了:"我收到了你发起建立连接的SYN分组，该分组带有初始序号client\_isn.我同意建立该连接我的初始序号为server\_isn。"该允许连接的报文段有时被称为**SYNACK报文段**。

## 第三步

在收到 SYNACK 报文段后客户也要给该连接分配缓存和变量。客户主机则向服务器发送另外一个报文段；这最后一个报文段对服务器的允许连接的报文段进行了确认(该客户将值**server\_isn+1** 放置到TCP报文段首部的确认字段中来完成此项工作)。因为连接已建立，所以该**SYN**比特被置为 **0** ，初始序号为 **client\_isn+1**。该三次握手的第三个阶段可以在报文段中**携带客户到服务器的数据**。

## 总结 

一旦完成这 3 个步骤，客户和服务主机就可以互相发送包括数据的报文段了。在以后的每个报文段中，**SYN 比特** 都将被置为 **0**.注意为了创建该连接，在两台主机之间发送了 3 个分组 如下图 由于这个原因，这种连接创建过程通常被称为**3次握手**

![三次握手示意图](https://copie.cn/usr/uploads/2017/09/2795939992.png)
